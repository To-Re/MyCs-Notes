# 第 6 章 整数集合

整数集合（instset）是集合键的底层实现之一，当一个集合只包含整数值元素，并且这个集合的元素数量不多时，Redis 就会使用整数集合作为集合键的底层实现。



## 6.1 整数集合的实现

整数集合是 Redis 用于保存整数值的集合抽象数据结构，它可以保存类型为 `int16_t` 、 `int32_t` 、 `int64_t` 的整数值，并且保证集合中不会出现重复元素。

每个 `intset.h/intset` 结构表示一个整数集合：

```c
typedef struct intset {
    // 编码方式
    uint32_t encoding;
    // 集合包含的元素数量
    uint32_t length;
    // 保存元素的数组
    int8_t contents[];
} intset;
```



contents 数组是整数集合的底层实现：整数集合的每个元素都是 contents 数组的一个数组项，各个项在数组中按照值的大小从小到大有序排序，并且数组中不包含任何重复项。

length 属性记录了整数集合包含的元素数量

虽然 content 是 `int8_t` 类型的数组，但存储的类型是取决于 encoding 属性的值



## 6.2 升级

当添加一个新元素到整数集合里面，并且新元素的类型比整数集合现有所有元素的类型要长时，整数集合需要先进性升级操作，然后才能将新元素添加到整数集合里面。

升级整数集合并添加新元素共分为三步进行：

+ 根据新元素的类型，扩展整数集合底层数据的空间大小，并为新元素分配空间。
+ 将底层数组现有的所有元素都转换成与新元素相同的类型，并将类型转换后的元素放置到正确的位上，而且在放置元素的过程中，需要继续维持底层数组的有序性质。
+ 将新元素添加到底层数组离

引发升级的元素，因为值不在原类型值域范围，所以只可能是大于所有元素，或小于所有元素。



## 6.3 升级的好处

+ 提升整数集合的灵活性
+ 尽可能节约内存



### 6.3.1 提升灵活性

可以将 `int16_t` 、 `int32_t` 、 `int64_t` 类型随意添加到集合中，而不必担心类型错误。



### 6.3.2 节约内存

如果直接使用 `int64_t` 类型保存三种类型的值，会造成内存浪费。



## 6.4 降级

整数集合不支持降级操作，一旦对数组进行了升级，编码就会一直保持升级后的状态。



## 6.5 整数集合 API

略



## 6.6 重点回顾

+ 整数集合是集合键的底层实现之一
+ 整数集合的底层实现为数组，数组有序、无重复方式保存集合元素
+ 升级操作为整数集合带来了操作上的灵活性，并且尽可能地节约了内存
+ 整数集合只支持升级操作，不支持降级操作



以下是我的总结

插入删除操作需要遍历集合，$O(N)$

查询可以通过二分查找，$O(logN)$

